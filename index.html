<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>G Train – Bedford–Nostrand Av</title>
		<script src="https://unpkg.com/gtfs-realtime-bindings/dist/gtfs-realtime-bindings.js"></script>
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1, maximum-scale=5, viewport-fit=cover, user-scalable=yes"
		/>
		<meta name="mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		<meta name="theme-color" content="#000000" />
		<style>
			html,
			body {
				margin: 0;
				padding: 0;
				background: black;
				min-height: 100vh;
				min-height: -webkit-fill-available;
				display: flex;
				align-items: center;
				justify-content: center;
				font-family: "Courier New", monospace;
				-webkit-font-smoothing: antialiased;
				-moz-osx-font-smoothing: grayscale;
			}

			.screen {
				background: #000;
				border: 4px solid #111;
				padding: clamp(16px, 5vw, 32px);
				color: #ffb000;
				text-shadow: 0 0 10px rgba(255, 176, 0, 0.65);
				letter-spacing: 2px;

				width: min(92vw, 800px);
				max-width: 100%;
				box-sizing: border-box;
				margin: 16px;
				border-radius: 8px;
			}
			.header {
				text-align: center;
				font-size: clamp(14px, 4.5vw, 28px);
				margin-bottom: clamp(12px, 4vw, 24px);
				font-weight: bold;
			}

			.row {
				display: flex;
				justify-content: space-between;
				align-items: center;
				font-size: clamp(16px, 4.5vw, 32px);
				margin: clamp(10px, 3vw, 18px) 0;
				gap: 12px;
			}

			.dir {
				color: #ffaa00;
				white-space: nowrap;
				flex-shrink: 0;
			}

			.times {
				color: #ffcc33;
				white-space: nowrap;
				text-align: right;
				overflow: hidden;
				text-overflow: ellipsis;
			}

			.blink {
				animation: blink 1s step-start infinite;
			}

			@keyframes blink {
				50% {
					opacity: 0;
				}
			}

			.footer {
				margin-top: clamp(12px, 4vw, 16px);
				font-size: clamp(9px, 2.5vw, 12px);
				opacity: 0.6;
				text-align: center;
			}
			.led-text {
				font-size: 26px;
				font-weight: bold;
				letter-spacing: 6px;
				color: transparent;

				background-image:
					radial-gradient(
						circle,
						#ffb000 45%,
						rgba(255, 176, 0, 0.15) 55%
					),
					radial-gradient(
						circle,
						#ffb000 45%,
						rgba(255, 176, 0, 0.15) 55%
					);
				background-size: 10px 10px;
				background-position:
					0 0,
					5px 5px;

				-webkit-background-clip: text;
				background-clip: text;

				filter: drop-shadow(
						0 0 6px rgba(255, 176, 0, 0.6)
					)
					drop-shadow(
						0 0 12px rgba(255, 176, 0, 0.35)
					);
			}

			/* Mobile-specific improvements */
			@media (max-width: 480px) {
				.screen {
					border-width: 2px;
					border-radius: 6px;
				}
				
				.row {
					font-size: clamp(14px, 4vw, 18px);
				}
				
				.times {
					font-size: clamp(13px, 3.5vw, 16px);
				}
			}
			
			/* Prevent zoom on focus for iOS */
			@media (max-width: 768px) {
				select, textarea, input, button {
					font-size: 16px !important;
				}
			}
			
			/* Better touch targets */
			@media (hover: none) and (pointer: coarse) {
				.screen {
					touch-action: manipulation;
				}
			}
		</style>
	</head>

	<body>
		<div class="screen">
			<div id="header" class="header"></div>

			<div class="row">
				<span class="dir">↑ QUEENS</span>
				<span id="north" class="times">—</span>
			</div>

			<div class="row">
				<span class="dir">↓ CHURCH AV&nbsp;</span>
				<span id="south" class="times">—</span>
			</div>

			<div class="footer">G TRAIN · LIVE</div>
		</div>

		<script>
			// Set random header message on page load
			const messages = [
				"CHAOS MODE HAZE",
				"GO FERAL HAZE",
				"UNHINGED HAZE",
				"MENACE MODE HAZE",
				"ABSOLUTE HAZE",
				"FERAL WALK HAZE",
				"FULL CHAOS HAZE",
				"UNLEASH HAZE",
				"NO THOUGHTS HAZE",
				"WILD ENERGY HAZE",
				"GO UNHINGED HAZE",
				"PURE CHAOS HAZE",
				"MENACE WALK HAZE",
				"FERAL SPEED HAZE",
				"ABSURD MODE HAZE",
				"CHAOS FOREVER HAZE"
			];
			
			const randomMessage = messages[Math.floor(Math.random() * messages.length)];
			document.getElementById("header").textContent = randomMessage;
		</script>

		<script type="module">
			import GtfsRealtimeBindings from "https://esm.sh/gtfs-realtime-bindings@1.0.0";

			const FEED_URL =
				"https://api-endpoint.mta.info/Dataservice/mtagtfsfeeds/nyct%2Fgtfs-g";

			const STOPS = {
				north: "G35N",
				south: "G35S",
			};
			console.log(GtfsRealtimeBindings);

			async function fetchArrivals() {
				try {
					const res = await fetch(FEED_URL);

					if (!res.ok)
						throw new Error("Fetch failed");

					const buffer = await res.arrayBuffer();
					const feed =
						GtfsRealtimeBindings.transit_realtime.FeedMessage.decode(
							new Uint8Array(buffer),
						);
					console.log("decoding");
					console.log("feed", feed);

					const now = Math.floor(
						Date.now() / 1000,
					);
					const arrivals = {
						north: [],
						south: [],
					};

					feed.entity.forEach((entity) => {
						console.log(entity);
						const updates =
							entity.tripUpdate
								?.stopTimeUpdate;
						if (!updates) return;

						updates.forEach((u) => {
							if (!u.arrival?.time)
								return;
							const eta =
								u.arrival.time -
								now;

							if (
								u.stopId ===
								STOPS.north
							)
								arrivals.north.push(
									eta,
								);
							if (
								u.stopId ===
								STOPS.south
							)
								arrivals.south.push(
									eta,
								);
						});
					});

					arrivals.north.sort((a, b) => a - b);
					arrivals.south.sort((a, b) => a - b);

					render(arrivals);
				} catch (e) {
					console.log("hard fail", e);
					document.getElementById(
						"north",
					).textContent = "NO DATA";
					document.getElementById(
						"south",
					).textContent = "NO DATA";
				}
			}

			function formatTimes(list) {
				if (!list.length) return "—";

				return list
					.slice(0, 3)
					.map((sec) => {
						if (sec <= 30)
							return `<span class="blink">ARR</span>`;
						return `${Math.floor(sec / 60)} min`;
					})
					.join(" · ");
			}

			function render(arrivals) {
				document.getElementById("north").innerHTML =
					formatTimes(arrivals.north);

				document.getElementById("south").innerHTML =
					formatTimes(arrivals.south);
			}

			fetchArrivals();
			setInterval(fetchArrivals, 30000);
		</script>
	</body>
</html>
